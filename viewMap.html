<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <!-- fontawesome icons -->
    <script src="https://kit.fontawesome.com/5d2140906c.js" crossorigin="anonymous"></script>
    <!-- autotools -->
    <script type="text/javascript" src="autotoolsfunctions.js"></script>
    <link type="text/css" rel="stylesheet" type="text/css" src="autotoolsstyle.css">
    <meta name="autotoolswebscreen" type="variablejs" id="userLocation" label="Current User Location" description="The coordinates of the user's current location, separated by a comma (,)" />
    <meta name="autotoolswebscreen" type="variablejs" id="userLocationAccuracy" label="Location Accuracy" description="The accuracy of the current location in meters" />
    <meta name="autotoolswebscreen" type="variablejs" id="taskerData" label="Park Data" description="The contents of 'coords.txt' file" />
    
    <title>View Trail Map</title>
</head>
<body>

    <div class="container-fluid">
        <br>
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="">View Trail Map</h1>
            <div>
                <div id="locate" class="btn btn-success" onclick="AutoTools.sendCommand('getLocation', 'tmc', true)">Locate&nbsp;<i class="fa-solid fa-location-dot"></i></div>
            </div>
        </div>
        <p id="debug" style="visibility:hidden"></p>

        <!-- select park -->
        <select id="selectPark" class="form-select form-select-lg mt-3" onchange="selectPark(this.value)">
            <option value="null">Select a Park</option>
        </select>

        <!-- interactive map -->
        <div class="mt-3" id="map" style="width: 100%; height: 600px;"></div>

        <!-- google drive link -->
        <div class="mt-3 me-auto">
            <a class="btn btn-primary" href="https://drive.google.com/drive/folders/1I6Fx5VxKQYPDSgGa1aw-DQkQsTM_K3aw" target="_blank"><i class="fa-brands fa-google-drive"></i> &nbsp;Open TMC in Google Drive</a>
        </div>

        <!-- edit mode -->
        <div id="editMode" class="mt-3">
            <div class="btn btn-warning" onclick='mapControl.enableEditMode()'><i class="fa-solid fa-pen-to-square"></i> &nbsp;Enable Edit Mode</div>
        </div>
        <div id="editModeMessage">
            <p class="mt-3 py-2 px-3 d-inline-block bg-success text-white rounded"><i class="fa-regular fa-circle-check"></i> &nbsp;Edit Mode Enabled</p>
        </div>
        <div id="commitModifications" class="mt-3">
            <div class="btn btn-danger" onclick="mapControl.commitChanges()"><i class="fa-solid fa-circle-chevron-right"></i> &nbsp;Commit Changes</div>
        </div>

        <br>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script id="modulesScript" type="text/javascript"></script>
    <script id="drawScript" type="text/javascript"></script>
    <script>

        // autotools related code
        parkData = null
        onMobile = false
        if (AutoTools.isSet("taskerData")) {
            // user is on mobile
            // $("#modulesScript").attr("src", "https://cdn.jsdelivr.net/gh/bphogat1006/Trail-Map-Creator/modules.js")
            // $("#drawScript").attr("src", "https://cdn.jsdelivr.net/gh/bphogat1006/Trail-Map-Creator/draw.js")
            document.getElementById("editMode").style.visibility = "hidden"
            onMobile = true
            parkData = taskerData
        } else {
            // user is on desktop
            $("#modulesScript").attr("src", "modules.js")
            $("#drawScript").attr("src", "draw.js")
            document.getElementById("locate").style.visibility = "hidden"
        }

        userLocation = null
        autoToolsUpdateValues = function(values) {
            if (userLocation != null ) {
                map.removeLayer(userLocation)
            }
            userLocation = L.layerGroup()
            coords = values.userLocation.split(",")
            coords = [parseFloat(coords[0]), parseFloat(coords[1])]
            accuracy = values.userLocationAccuracy
            userLocationMarker = L.marker(coords)
            userLocationAccuracy = L.circle(coords, {
                radius: accuracy,
                opacity: 0,
                fillColor: 'blue',
                fillOpacity: 0.4
            })
            userLocation.addLayer(userLocationMarker)
            userLocation.addLayer(userLocationAccuracy)
            userLocation.addTo(map)
            map.flyTo(coords, map.getZoom(), {duration: 2.5})
        }

        // document related code
        $(() => {
            $("#editModeMessage").hide()
            $("#commitModifications").hide()
        })

        function selectPark(selectedPark) {
            mapControl.reset()
            if (selectedPark != "null") {
                parseDataFile(parkData, selectedPark)
                    .then(data => {
                        drawParkData(data)
                        mapControl.finalize()
                    })
            }
        }

        function debug(message) {
            $("#debug").css("visibility", "visible")
            $("#debug").text($("#debug").text()+" "+message)
        }
        
        // leaflet related code
        var center = null
        var map = null
        var mapControl = null

        // prepare map & mapControl
        function ready() {

            // selectPark("Libro Forest") // TEMPORARY ---- COMMENT OUT
            
            center = [40.086203, -74.707617]
            map = L.map('map').setView(center, 13);
            mapControl = new MapControl()

            // populate park select dropdown with park names
            parseDataFile(parkData, null, true)
                .then(data => {
                    parkNames = data
                    for (parkName of parkNames) {
                        newPark = $("#selectPark :first-child").clone()
                        newPark.attr("value", parkName)
                        newPark.text(parkName)
                        newPark.appendTo($("#selectPark"))
                    }
                })
            
            // set up base map layers
            var outdoorsMap = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 23,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox/outdoors-v11',
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map)
            var satelliteMap = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 23,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox/satellite-v9',
                tileSize: 512,
                zoomOffset: -1
            })
            L.control.layers({
                "Street": outdoorsMap,
                "Satellite": satelliteMap
            }).addTo(map)
            
            L.control.scale().addTo(map);
        }
        if (onMobile) {
            ready()
        }
    </script>
</body>
</html>