<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <!-- fontawesome icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- autotools -->
    <script type="text/javascript" src="autotoolsfunctions.js"></script>
    <link type="text/css" rel="stylesheet" type="text/css" src="autotoolsstyle.css">
    <meta name="autotoolswebscreen" type="variablejs" id="currLocation" label="Current Location" description="The coordinates of the user's current location, separated by a comma (,)" />
    <meta name="autotoolswebscreen" type="variablejs" id="locationAccuracy" label="Location Accuracy" description="The accuracy of the current location in meters" />
    <meta name="autotoolswebscreen" type="variablejs" id="coordsData" label="Park Data" description="The contents of 'coords.txt' file" />
    
    <title>View Trail Map</title>
    <style></style>
</head>
<body>

    <div class="container-fluid">
        <br>
        <h1>View Trail Map</h1>

        <!-- select park -->
        <select id="selectPark" class="form-select form-select-lg mt-3" onchange="selectPark(this.value)">
            <option value="null">Select a Park</option>
        </select>

        <!-- interactive map -->
        <div class="mt-3" id="map" style="width: 100%; height: 500px;"></div>

        <!-- download coords link -->
        <div class="mt-3 me-auto">
            <a class="btn btn-primary mt-3" href="https://drive.google.com/file/d/1SYdCU8XFWex02pqbbHsDmp7YktFZ7237/view" target="_blank"><i class="fa fa-download"></i> &nbspDownload Coordinates File</a>
        </div>

        <!-- toggle edit mode -->
        <div class="bg-secondary mt-3 p-2 rounded d-inline-block" id="editModeContainer">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="editModeSwitch" onchange="toggleEditMode(this)">
                <label class="form-check-label text-white" for="editModeSwitch">Enable Edit Mode</label>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script id="modulesScript" type="text/javascript"></script>
    <script id="drawScript" type="text/javascript"></script>
    <script>
        // autotools related code
        var parkData = null
        if (AutoTools.isSet("coordsData")) {
            // user is on mobile
            $("#modulesScript").attr("src", "https://cdn.jsdelivr.net/gh/bphogat1006/Trail-Map-Creator/modules.js")
            $("#drawScript").attr("src", "https://cdn.jsdelivr.net/gh/bphogat1006/Trail-Map-Creator/draw.js")
            parkData = coordsData
            alert(parkData)
        } else {
            // user is on desktop
            $("#modulesScript").attr("src", "modules.js")
            $("#drawScript").attr("src", "draw.js")
        }

        // document related code
        function selectPark(park) {
            if (park != "null") {
                drawParkTrails(park)
            } else {
                mapControl.reset()
            }
        }

        function toggleEditMode(e) {
            if (e.checked) {
                mapControl.reset()

            }
        }
        
        // leaflet related code
        var center = null
        var map = null
        var mapControl = null

        function drawParkTrails(park) {
            parseDataFile(parkData)
                .then(data => {
                    drawMapData(park, data)
                    mapControl.finalize()
                })
        }

        // prepare map & mapControl
        function ready() {

            // drawParkTrails("Libro Forest") // TEMPORARY ---- COMMENT OUT
            
            center = [40.086203, -74.707617]
            map = L.map('map').setView(center, 13);
            mapControl = new MapControl()

            // populate park select dropdown with park names
            parseDataFile(parkData, true)
                .then(data => {
                    parkNames = data
                    for (parkName of parkNames) {
                        newPark = $("#selectPark :first-child").clone()
                        newPark.attr("value", parkName)
                        newPark.text(parkName)
                        newPark.appendTo($("#selectPark"))
                    }
                })
            
            // set up base map layers
            var outdoorsMap = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 22,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox/outdoors-v11',
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map)
            var satelliteMap = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 22,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox/satellite-v9',
                tileSize: 512,
                zoomOffset: -1
            })
            mapControl.addBaseLayer("Street", outdoorsMap)
            mapControl.addBaseLayer("Satellite", satelliteMap)
            
            L.control.scale().addTo(map);
        }
    </script>
</body>
</html>